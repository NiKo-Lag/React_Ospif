import React, { useState, useMemo } from 'react';
import { X, Edit3, Save, AlertTriangle, TrendingUp, Repeat, Star, Award, Share2 } from 'lucide-react';

// --- Mock Data ---
// Data needed for this specific component to run independently.
const beneficiariesData = {
    1: {
        id: 1, name: 'Juan Pérez', cuil: '20404803574', memberId: '20404803574/00', dob: '1980-03-15', sex: 'Masculino', phone: '11-5555-1234', email: 'juan.perez@email.com',
        address: 'Av. Corrientes 1234, 5A', province: 'CABA',
        beneficiaryType: 'Relación de Dependencia', hasDisability: true, reviewStatus: 'Al día', status: 'Activo', planType: 'Platino',
        chronicConditions: ['Hipertensión Arterial', 'Alergia a Penicilina'],
        monthlyMedication: ['Losartan 50mg', 'Aspirina Prevent 100mg'],
        internalProfile: 'Paciente con hipertensión arterial crónica. Requiere control periódico de presión y medicación regular (Losartan). Alergia a la penicilina.',
        history: [
            { id: 'INT-7651', type: 'Internación', date: '2024-07-29', description: 'Cirugía de apéndice', provider: 'Hospital Central', status: 'Requiere Auditoría' },
            { id: 'PRA-4532', type: 'Prácticas', date: '2024-07-28', description: 'Análisis de sangre completo.', provider: 'Centro de Diagnóstico', status: 'Aprobado' },
            { id: 'MED-9870', type: 'Medicación', date: '2024-07-05', description: 'Losartan 50mg x 30', provider: 'Farmacia del Sol', status: 'Aprobado' },
            { id: 'MED-9865', type: 'Medicación', date: '2024-06-05', description: 'Losartan 50mg x 30', provider: 'Farmacia del Sol', status: 'Aprobado' },
            { id: 'PRO-2340', type: 'Prótesis', date: '2024-05-15', description: 'Tornillos para fractura', provider: 'OrtoSalud S.A.', status: 'Aprobado' },
        ]
    },
    2: {
        id: 2, name: 'Ana Gómez', cuil: '27954567891', memberId: '27954567891/00', dob: '1995-08-20', sex: 'Femenino', phone: '11-5555-5678', email: 'ana.gomez@email.com',
        address: 'Calle Falsa 123', province: 'Buenos Aires',
        beneficiaryType: 'Monotributo', hasDisability: false, reviewStatus: 'Pago pendiente', status: 'Activo', planType: 'Bordo',
        chronicConditions: [], monthlyMedication: [], internalProfile: '',
        history: []
    },
    // Add other beneficiaries here if needed for ranking calculation
};


// --- Helper Components & Functions ---
const calculateAge = (dobString) => { 
    const dob = new Date(dobString); 
    const today = new Date(); 
    let age = today.getFullYear() - dob.getFullYear(); 
    const m = today.getMonth() - dob.getMonth(); 
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { 
        age--; 
    } 
    return age; 
};

const InfoRow = ({ label, children }) => (
    <div className="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
        <p className="text-sm text-gray-500">{label}</p>
        <div className="text-sm font-medium text-gray-800 text-right">{children}</div>
    </div>
);

const KpiItem = ({ icon, label, children }) => (
    <div className="flex items-center space-x-3">
        <div className="bg-gray-100 p-2 rounded-lg">{icon}</div>
        <div>
            <p className="text-sm text-gray-500">{label}</p>
            <div className="font-bold text-gray-800">{children}</div>
        </div>
    </div>
);

const AlertBanner = ({ text }) => (
    <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-r-lg mb-6 flex items-center">
        <AlertTriangle className="mr-3" />
        <p className="font-bold">{text}</p>
    </div>
);


// --- Main Beneficiary Profile Component ---
const BeneficiaryProfile = ({ beneficiary, allBeneficiaries }) => {
    const [activeTab, setActiveTab] = useState('Internación');
    const [isEditingProfile, setIsEditingProfile] = useState(false);
    const [isEditingClinical, setIsEditingClinical] = useState(false);
    
    const [profileText, setProfileText] = useState(beneficiary.internalProfile);
    const [chronicText, setChronicText] = useState((beneficiary.chronicConditions || []).join(', '));
    const [medicationText, setMedicationText] = useState((beneficiary.monthlyMedication || []).join(', '));

    const kpis = useMemo(() => {
        if (!beneficiary || !beneficiary.history || beneficiary.history.length === 0) {
            return { total: 0, frequency: "N/A", topProvider: "N/A", rank: "N/A", totalBeneficiaries: Object.keys(allBeneficiaries).length };
        }
        
        const total = beneficiary.history.length;
        
        const dates = beneficiary.history.map(h => new Date(h.date));
        const minDate = new Date(Math.min.apply(null, dates));
        const maxDate = new Date(Math.max.apply(null, dates));
        const months = (maxDate.getFullYear() - minDate.getFullYear()) * 12 + (maxDate.getMonth() - minDate.getMonth()) + 1;
        const frequency = (total / (months || 1)).toFixed(1);

        const providerCounts = beneficiary.history.reduce((acc, h) => {
            if(h.provider) acc[h.provider] = (acc[h.provider] || 0) + 1;
            return acc;
        }, {});
        const topProvider = Object.keys(providerCounts).reduce((a, b) => providerCounts[a] > providerCounts[b] ? a : b, "N/A");

        const consumptionList = Object.values(allBeneficiaries).map(b => ({ id: b.id, count: (b.history || []).length })).sort((a, b) => b.count - a.count);
        const rank = consumptionList.findIndex(b => b.id === beneficiary.id) + 1;

        return { total, frequency, topProvider, rank, totalBeneficiaries: consumptionList.length };
    }, [beneficiary, allBeneficiaries]);

    const historyByType = useMemo(() => {
        return (beneficiary.history || []).reduce((acc, item) => { 
            if (!acc[item.type]) { acc[item.type] = []; } 
            acc[item.type].push(item); 
            return acc; 
        }, {});
    }, [beneficiary.history]);

    const tabs = ['Internación', 'Prácticas', 'Medicación', 'Traslado', 'Prótesis'];

    const criticalStatus = beneficiary.status !== 'Activo' ? `Beneficiario en estado ${beneficiary.status}` : beneficiary.reviewStatus !== 'Al día' ? `Situación de revista: ${beneficiary.reviewStatus}` : null;

    if (!beneficiary) return <p>Beneficiary not found.</p>;

    return (
        <div className="bg-gray-50 rounded-2xl w-full max-w-6xl mx-auto my-8 flex flex-col shadow-lg">
            <div className="flex justify-between items-center p-6 border-b border-gray-200">
                <div className="flex items-center space-x-4">
                    <h2 className="text-2xl font-bold text-gray-900">Perfil del Beneficiario: {beneficiary.name}</h2>
                    <span className={`px-3 py-1 text-xs font-semibold rounded-full ${beneficiary.status === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-700'}`}>{beneficiary.status}</span>
                </div>
                <div className="flex items-center space-x-4">
                    <button className="text-gray-400 hover:text-gray-600 transition-colors">
                        <Share2 size={22} />
                    </button>
                    <button className="text-gray-400 hover:text-gray-600 transition-colors">
                        <X size={28} />
                    </button>
                </div>
            </div>
            <div className="flex-grow p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Left Column */}
                <div className="lg:col-span-1 space-y-6">
                    {criticalStatus && <AlertBanner text={criticalStatus} />}
                    <div className="bg-white p-6 rounded-xl shadow-sm">
                        <h3 className="font-bold text-lg mb-4">Datos Personales</h3>
                        <div className="space-y-1">
                            <InfoRow label="N° Afiliado"><span>{beneficiary.memberId}</span></InfoRow>
                            <InfoRow label="CUIL"><span>{beneficiary.cuil}</span></InfoRow>
                            <InfoRow label="Sexo"><span>{beneficiary.sex}</span></InfoRow>
                            <InfoRow label="Edad"><span>{calculateAge(beneficiary.dob)} años</span></InfoRow>
                            <InfoRow label="Dirección"><span>{beneficiary.address}</span></InfoRow>
                            <InfoRow label="Provincia"><span>{beneficiary.province}</span></InfoRow>
                            <InfoRow label="Tipo Beneficiario"><span>{beneficiary.beneficiaryType}</span></InfoRow>
                            <InfoRow label="Plan"><span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${beneficiary.planType === 'Platino' ? 'bg-gray-700 text-white' : 'bg-amber-600 text-white'}`}>{beneficiary.planType}</span></InfoRow>
                            <InfoRow label="Discapacidad"><span>{beneficiary.hasDisability ? 'Sí' : 'No'}</span></InfoRow>
                            <InfoRow label="Situación Revista"><span>{beneficiary.reviewStatus}</span></InfoRow>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm">
                        <h3 className="font-bold text-lg mb-4">KPIs de Consumo</h3>
                        <div className="space-y-4">
                            <KpiItem icon={<TrendingUp size={20} className="text-green-600"/>}><p>{kpis.total} Consumos Totales</p></KpiItem>
                            <KpiItem icon={<Repeat size={20} className="text-blue-600"/>}><p>{`${kpis.frequency} / mes`}</p></KpiItem>
                            <KpiItem icon={<Star size={20} className="text-yellow-600"/>}><p>{kpis.topProvider}</p></KpiItem>
                            <KpiItem icon={<Award size={20} className="text-indigo-600"/>}>
                                <div className="w-full">
                                    <div className="flex justify-between text-xs mb-1">
                                        <span>Ranking</span>
                                        <span>{`${kpis.rank} / ${kpis.totalBeneficiaries}`}</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                        <div className="bg-indigo-500 h-2 rounded-full" style={{ width: `${(1 - (kpis.rank - 1) / kpis.totalBeneficiaries) * 100}%` }}></div>
                                    </div>
                                </div>
                            </KpiItem>
                        </div>
                    </div>
                </div>

                {/* Right Column */}
                <div className="lg:col-span-2 space-y-6">
                     <div className="bg-white p-6 rounded-xl shadow-sm">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Resumen Clínico</h3><button onClick={() => setIsEditingClinical(!isEditingClinical)} className="text-sm text-indigo-600 hover:text-indigo-800 flex items-center space-x-1">{isEditingClinical ? <><Save size={16}/><span>Guardar</span></> : <><Edit3 size={16}/><span>Editar</span></>}</button></div>
                        {isEditingClinical ? (<div className="space-y-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">Enfermedades Crónicas (separadas por coma)</label><input type="text" value={chronicText} onChange={(e) => setChronicText(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500" /></div><div><label className="block text-sm font-medium text-gray-700 mb-1">Medicación Mensual (separada por coma)</label><input type="text" value={medicationText} onChange={(e) => setMedicationText(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500" /></div></div>) : (<div className="space-y-4"><div><h4 className="text-sm font-semibold text-gray-600 mb-2">Enfermedades Crónicas</h4><div className="flex flex-wrap gap-2">{chronicText.split(',').map(c => c.trim()).filter(c => c).length > 0 ? chronicText.split(',').map(c => c.trim()).filter(c => c).map(c => <span key={c} className="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-1 rounded-full flex items-center"><AlertTriangle size={12} className="mr-1.5"/>{c}</span>) : <p className="text-xs text-gray-400">No registradas.</p>}</div></div><div><h4 className="text-sm font-semibold text-gray-600 mb-2">Medicación Mensual</h4><div className="flex flex-wrap gap-2">{medicationText.split(',').map(m => m.trim()).filter(m => m).length > 0 ? medicationText.split(',').map(m => m.trim()).filter(m => m).map(m => <span key={m} className="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full">{m}</span>) : <p className="text-xs text-gray-400">No registrada.</p>}</div></div></div>)}
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Comentarios Internos</h3><button onClick={() => setIsEditingProfile(!isEditingProfile)} className="text-sm text-indigo-600 hover:text-indigo-800 flex items-center space-x-1">{isEditingProfile ? <><Save size={16}/><span>Guardar</span></> : <><Edit3 size={16}/><span>Editar</span></>}</button></div>
                        {isEditingProfile ? (<textarea value={profileText} onChange={(e) => setProfileText(e.target.value)} className="w-full h-24 p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500"/>) : (<p className="text-sm text-gray-600 whitespace-pre-wrap">{profileText || 'No hay notas en el perfil.'}</p>)}
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm">
                        <h3 className="font-bold text-lg mb-4">Historial de Prácticas</h3>
                        <div className="border-b border-gray-200"><nav className="-mb-px flex space-x-6 overflow-x-auto">{tabs.map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${activeTab === tab ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>{tab}</button>))}</nav></div>
                        <div className="mt-4 space-y-3 h-[25vh] overflow-y-auto pr-2">
                           {(historyByType[activeTab] || []).length > 0 ? (historyByType[activeTab].map(item => (<div key={item.id} className="p-3 bg-gray-50 rounded-lg border border-gray-200"><p className="font-semibold text-sm">{new Date(item.date).toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric' })} - <span className={item.status === 'Aprobado' ? 'text-green-600' : item.status === 'Rechazado' ? 'text-red-600' : 'text-yellow-600'}>{item.status}</span></p><p className="text-sm text-gray-600">{item.description}</p></div>))) : (<p className="text-sm text-gray-400 text-center pt-10">No hay registros para esta categoría.</p>)}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- App Component to render the profile ---
export default function App() {
  const [beneficiary, setBeneficiary] = useState(beneficiariesData[1]);
  
  return (
    <div className="bg-gray-200 p-4">
        <BeneficiaryProfile 
            beneficiary={beneficiary} 
            allBeneficiaries={beneficiariesData} 
        />
    </div>
  );
}
